"use strict";import H from"../parts/Globals.js";import U from"../parts/Utilities.js";var extend=U.extend,isNumber=U.isNumber,syncTimeout=U.syncTimeout;import"../parts/Chart.js";import"../parts/Series.js";var labelDistance=3,addEvent=H.addEvent,pick=H.pick,Series=H.Series,SVGRenderer=H.SVGRenderer,Chart=H.Chart;function ccw(t,e,r,i,o,a){var n=(a-e)*(r-t)-(i-e)*(o-t);return n>0||!(n<0)}function intersectLine(t,e,r,i,o,a,n,h){return ccw(t,e,o,a,n,h)!==ccw(r,i,o,a,n,h)&&ccw(t,e,r,i,o,a)!==ccw(t,e,r,i,n,h)}function boxIntersectLine(t,e,r,i,o,a,n,h){return intersectLine(t,e,t+r,e,o,a,n,h)||intersectLine(t+r,e,t+r,e+i,o,a,n,h)||intersectLine(t,e+i,t+r,e+i,o,a,n,h)||intersectLine(t,e,t,e+i,o,a,n,h)}function drawLabels(t){var e=this,r=H.animObject(e.renderer.globalAnimation).duration;e.labelSeries=[],e.labelSeriesMaxSum=0,H.clearTimeout(e.seriesLabelTimer),e.series.forEach(function(i){var o=i.options.label,a=i.labelBySeries,n=a&&a.closest;o.enabled&&i.visible&&(i.graph||i.area)&&!i.isSeriesBoosting&&(e.labelSeries.push(i),o.minFontSize&&o.maxFontSize&&(i.sum=i.yData.reduce(function(t,e){return(t||0)+(e||0)},0),e.labelSeriesMaxSum=Math.max(e.labelSeriesMaxSum,i.sum)),"load"===t.type&&(r=Math.max(r,H.animObject(i.options.animation).duration)),n&&(void 0!==n[0].plotX?a.animate({x:n[0].plotX+n[1],y:n[0].plotY+n[2]}):a.attr({opacity:0})))}),e.seriesLabelTimer=syncTimeout(function(){e.series&&e.labelSeries&&e.drawSeriesLabels()},e.renderer.forExport||!r?0:r)}H.setOptions({plotOptions:{series:{label:{enabled:!0,connectorAllowed:!1,connectorNeighbourDistance:24,minFontSize:null,maxFontSize:null,onArea:null,style:{fontWeight:"bold"},boxesToAvoid:[]}}}}),SVGRenderer.prototype.symbols.connector=function(t,e,r,i,o){var a,n,h=o&&o.anchorX,s=o&&o.anchorY,c=r/2;return isNumber(h)&&isNumber(s)&&(a=["M",h,s],(n=e-s)<0&&(n=-i-n),n<r&&(c=h<t+r/2?n:r-n),s>e+i?a.push("L",t+c,e+i):s<e?a.push("L",t+c,e):h<t?a.push("L",t,e+i/2):h>t+r&&a.push("L",t+r,e+i/2)),a||[]},Series.prototype.getPointsOnGraph=function(){if(this.xAxis||this.yAxis){var t,e,r,i,o,a,n,h,s,c,l=this.points,p=[],d=this.graph||this.area,b=d.element,u=this.chart.inverted,x=this.xAxis,f=this.yAxis,m=u?f.pos:x.pos,g=u?x.pos:f.pos,w=pick(this.options.label.onArea,!!this.area),y=f.getThreshold(this.options.threshold),Y={};if(this.getPointSpline&&b.getPointAtLength&&!w&&l.length<this.chart.plotSizeX/16){for(d.toD&&(c=d.attr("d"),d.attr({d:d.toD})),n=b.getTotalLength(),r=0;r<n;r+=16)X({chartX:m+(t=b.getPointAtLength(r)).x,chartY:g+t.y,plotX:t.x,plotY:t.y});c&&d.attr({d:c}),(t=l[l.length-1]).chartX=m+t.plotX,t.chartY=g+t.plotY,X(t)}else for(n=l.length,r=0;r<n;r+=1){if(t=l[r],e=l[r-1],t.chartX=m+t.plotX,t.chartY=g+t.plotY,w&&(t.chartCenterY=g+(t.plotY+pick(t.yBottom,y))/2),r>0&&(i=Math.abs(t.chartX-e.chartX),o=Math.abs(t.chartY-e.chartY),(a=Math.max(i,o))>16))for(h=Math.ceil(a/16),s=1;s<h;s+=1)X({chartX:e.chartX+(t.chartX-e.chartX)*(s/h),chartY:e.chartY+(t.chartY-e.chartY)*(s/h),chartCenterY:e.chartCenterY+(t.chartCenterY-e.chartCenterY)*(s/h),plotX:e.plotX+(t.plotX-e.plotX)*(s/h),plotY:e.plotY+(t.plotY-e.plotY)*(s/h)});isNumber(t.plotY)&&X(t)}return p}function X(t){var e=Math.round(t.plotX/8)+","+Math.round(t.plotY/8);Y[e]||(Y[e]=1,p.push(t))}},Series.prototype.labelFontSize=function(t,e){return t+this.sum/this.chart.labelSeriesMaxSum*(e-t)+"px"},Series.prototype.checkClearPoint=function(t,e,r,i){var o,a,n,h,s,c,l,p,d,b,u,x=Number.MAX_VALUE,f=Number.MAX_VALUE,m=pick(this.options.label.onArea,!!this.area),g=m||this.options.label.connectorAllowed,w=this.chart;for(p=0;p<w.boxesToAvoid.length;p+=1)if(b=w.boxesToAvoid[p],!((u={left:t,right:t+r.width,top:e,bottom:e+r.height}).left>b.right||u.right<b.left||u.top>b.bottom||u.bottom<b.top))return!1;for(p=0;p<w.series.length;p+=1)if(h=(n=w.series[p]).interpolatedPoints,n.visible&&h){for(d=1;d<h.length;d+=1){if(h[d].chartX>=t-16&&h[d-1].chartX<=t+r.width+16){if(boxIntersectLine(t,e,r.width,r.height,h[d-1].chartX,h[d-1].chartY,h[d].chartX,h[d].chartY))return!1;this===n&&!s&&i&&(s=boxIntersectLine(t-16,e-16,r.width+32,r.height+32,h[d-1].chartX,h[d-1].chartY,h[d].chartX,h[d].chartY))}!g&&!s||this===n&&!m||(c=t+r.width/2-h[d].chartX,l=e+r.height/2-h[d].chartY,x=Math.min(x,c*c+l*l))}if(!m&&g&&this===n&&(i&&!s||x<Math.pow(this.options.label.connectorNeighbourDistance,2))){for(d=1;d<h.length;d+=1)(o=Math.min(Math.pow(t+r.width/2-h[d].chartX,2)+Math.pow(e+r.height/2-h[d].chartY,2),Math.pow(t-h[d].chartX,2)+Math.pow(e-h[d].chartY,2),Math.pow(t+r.width-h[d].chartX,2)+Math.pow(e-h[d].chartY,2),Math.pow(t+r.width-h[d].chartX,2)+Math.pow(e+r.height-h[d].chartY,2),Math.pow(t-h[d].chartX,2)+Math.pow(e+r.height-h[d].chartY,2)))<f&&(f=o,a=h[d]);s=!0}}return!(i&&!s)&&{x:t,y:e,weight:function(t,e){return t-e}(x,a?f:0),connectorPoint:a}},Chart.prototype.drawSeriesLabels=function(){var t=this,e=this.labelSeries;t.boxesToAvoid=[],e.forEach(function(e){e.interpolatedPoints=e.getPointsOnGraph(),(e.options.label.boxesToAvoid||[]).forEach(function(e){t.boxesToAvoid.push(e)})}),t.series.forEach(function(e){if(e.xAxis||e.yAxis){var r,i,o,a,n,h,s,c,l,p=[],d=e.options.label,b=t.inverted,u=b?e.yAxis.pos:e.xAxis.pos,x=b?e.xAxis.pos:e.yAxis.pos,f=t.inverted?e.yAxis.len:e.xAxis.len,m=t.inverted?e.xAxis.len:e.yAxis.len,g=e.interpolatedPoints,w=pick(d.onArea,!!e.area),y=e.labelBySeries,Y=!y,X=d.minFontSize,S=d.maxFontSize,M="highcharts-color-"+pick(e.colorIndex,"none");if(w&&!b&&(s=[e.xAxis.toPixels(e.xData[0]),e.xAxis.toPixels(e.xData[e.xData.length-1])],c=Math.min.apply(Math,s),l=Math.max.apply(Math,s)),e.visible&&!e.isSeriesBoosting&&g){for(y||(e.labelBySeries=y=t.renderer.label(e.name,0,-9999,"connector").addClass("highcharts-series-label highcharts-series-label-"+e.index+" "+(e.options.className||"")+M),t.renderer.styledMode||y.css(extend({color:w?t.renderer.getContrast(e.color):e.color},e.options.label.style)),X&&S&&y.css({fontSize:e.labelFontSize(X,S)}),y.attr({padding:0,opacity:t.renderer.forExport?1:0,stroke:e.color,"stroke-width":1,zIndex:3}).add()),(r=y.getBBox()).width=Math.round(r.width),n=g.length-1;n>0;n-=1)w?(C(i=g[n].chartX-r.width/2,o=g[n].chartCenterY-r.height/2,r)&&(h=e.checkClearPoint(i,o,r)),h&&p.push(h)):(C(i=g[n].chartX+labelDistance,o=g[n].chartY-r.height-labelDistance,r)&&(h=e.checkClearPoint(i,o,r,!0)),h&&p.push(h),C(i=g[n].chartX+labelDistance,o=g[n].chartY+labelDistance,r)&&(h=e.checkClearPoint(i,o,r,!0)),h&&p.push(h),C(i=g[n].chartX-r.width-labelDistance,o=g[n].chartY+labelDistance,r)&&(h=e.checkClearPoint(i,o,r,!0)),h&&p.push(h),C(i=g[n].chartX-r.width-labelDistance,o=g[n].chartY-r.height-labelDistance,r)&&(h=e.checkClearPoint(i,o,r,!0)),h&&p.push(h));if(d.connectorAllowed&&!p.length&&!w)for(i=u+f-r.width;i>=u;i-=16)for(o=x;o<x+m-r.height;o+=16)(a=e.checkClearPoint(i,o,r,!0))&&p.push(a);if(p.length){p.sort(function(t,e){return e.weight-t.weight}),h=p[0],t.boxesToAvoid.push({left:h.x,right:h.x+r.width,top:h.y,bottom:h.y+r.height});var A=Math.sqrt(Math.pow(Math.abs(h.x-y.x),2),Math.pow(Math.abs(h.y-y.y),2));if(A){var v={opacity:t.renderer.forExport?1:0,x:h.x,y:h.y},L={opacity:1};A<=10&&(L={x:v.x,y:v.y},v={}),e.labelBySeries.attr(extend(v,{anchorX:h.connectorPoint&&h.connectorPoint.plotX+u,anchorY:h.connectorPoint&&h.connectorPoint.plotY+x})).animate(L,Y?.2*H.animObject(e.options.animation).duration:t.renderer.globalAnimation),e.options.kdNow=!0,e.buildKDTree();var P=e.searchPoint({chartX:h.x,chartY:h.y},!0);y.closest=[P,h.x-P.plotX,h.y-P.plotY]}}else k()}else k()}function C(t,e,r){var i=Math.max(u,pick(c,-1/0)),o=Math.min(u+f,pick(l,1/0));return t>i&&t<=o-r.width&&e>=x&&e<=x+m-r.height}function k(){y&&(e.labelBySeries=y.destroy())}}),H.fireEvent(t,"afterDrawSeriesLabels")},addEvent(Chart,"load",drawLabels),addEvent(Chart,"redraw",drawLabels);